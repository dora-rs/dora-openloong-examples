# 结题报告
## 项目信息
- 项目名称
  - doraopenloong 软件集成与示例工作流构建
- 方案描述
  - 本项目围绕 OpenLoong 人形机器人生态，基于 dora-rs 中间件构建端到端的数据流工作流，打通上肢控制、底盘/机械臂控制、GPS 导航等关键链路，形成 gRPC 与 UDP 两类示例；在此基础上，提供面向仿真环境的一键化启动脚本与工作流，便于在开发阶段复现实验、进行联调和回归验证。
- 时间规划
  - 第一阶段（6/15-6/30）：环境准备与样例运行。完成 dora 环境搭建、Dora 样例跑通；完成 OpenLoong 全身动力学仿真环境搭建并运行；在 Ubuntu/macOS 上验证 gRPC 构建可行性与示例。
  - 第二阶段（7/1-7/15）：接口/工作流实现与联调。补齐 GPS 导航与上肢控制的 gRPC server/client 示例；在 UDP 通道上实现关节与机械臂控制数据流，完成 Dora 工作流节点编写与 dataflow 配置，并通过最小化可复现实例进行联调。
  - 第三阶段（7/16-7/31）：稳定性加固与文档完善。聚焦 dataflow 配置健壮性、输入流关闭（INPUT_CLOSED）问题绕过与后续改进方案；整合文档、补充使用说明与脚本化启动，输出开发日志。
  - 第四阶段（8/1-8/31）：
  - 第五阶段（9/1-9/30）：
---
## 背景与目标
OpenLoong 现有栈以 ROS 为主，面向复杂具身智能系统在通信拓扑、实时性、AI 集成与可维护性方面存在挑战。dora-rs 在低延迟数据通道、调度与 AI 生态方面具备优势，适合作为新一代机器人运行时中间件。本项目目标是：
- 在不改变 OpenLoong 既有仿真/控制 SDK 的前提下，以 dora-rs 为纽带，构建“仿真—接口—工作流”的贯通样例。
- 以 gRPC（导航、上肢）与 UDP（关节、机械臂）为两类典型通信模式，提供最小可用实现，便于后续替换/扩展。
- 输出文档与一键化脚本，降低复现与二次开发门槛，连通导航与控制链路。

## 系统与代码结构
仓库核心目录与定位如下：
- `Openloong-proto/`：统一的 Protobuf 协议集合，覆盖 `gps_navigation.proto`、`upper_controller.proto`、`chassis_controller.proto`、`navigation.proto`、`feedback.proto`、`skill_manager.proto` 等。
- `gps_navigation_grpc/`：GPS 导航 gRPC 示例。
  - `gps_navigation_server.py`：实现 `setDestination`、`startNavi`（流式）、`stopNavi`、`getState` 四个服务接口，具备最小可运行逻辑与状态返回。
  - `gps_navigation_client.py`：客户端样例，演示状态查询、目标点设置、导航启动/停止的完整调用流程。
- `upper_controller/`：上肢控制 gRPC 示例。
  - `upper_controller_server.py`：实现末端/手臂动作下发与状态读取、配置下发与读取、颈/腰姿态设置与获取等接口，端口为 50052。
  - `upper_controller_client.py`：对应客户端调用脚本，覆盖各接口的调用与返回值打印。
- `openloong-dora-udp/`：基于 UDP 的 Dora 工作流示例。
  - `servers/`：关节/机械臂/模拟服务端参考实现。
  - `workflow/`：Dora 节点（客户端）与 `dataflow.yml`、`workflow_orchestrator.py` 等。
  - `sdk/`：从 `loong_sim_sdk_release` 引入的关节与机械臂控制 SDK。
- `openloong-dora-sim/`：全链仿真与工作流对接。
  - `sim_run.sh`：一键启动脚本，负责按序拉起仿真、驱动、接口、运动与 Dora 工作流，支持 `--no-jnt/--no-mani` 可选项。
  - `workflow/`：用于与 SDK/仿真对接的数据流配置与节点。
- `Openloong-nav-warpper/loong_planner/`：LoongPlanner（ROS 局部规划插件）说明与参数示例，支持路径跟随、速度平滑、终点微调与代价图避障。
- `Doc/`：接口协议说明 PDF（GPS 导航、上肢控制、底盘控制等）。

## 主要实现与功能说明
1) GPS 导航 gRPC 服务
- 接口定义来源于 `Openloong-proto/gps_navigation.proto`。
- 服务端脚本 `gps_navigation_server.py`：
  - `setDestination(Pose) -> Response`：设置目标位姿。
  - `startNavi(Empty) -> stream NaviResponse`：流式返回导航进展，包含 `succeeded/msg/arrived/state` 等字段；示例实现每秒一次，共 3 次返回，末次 `arrived=True`。
  - `stopNavi(Empty) -> Response`：停止导航。
  - `getState(Empty) -> State`：查询当前位姿、速度与姿态。
- 客户端脚本 `gps_navigation_client.py`：串联调用 `getState → setDestination → startNavi → stopNavi → getState`，覆盖完整业务闭环。

2) 上肢控制 gRPC 服务
- 接口定义来源于 `Openloong-proto/upper_controller.proto`。
- 服务端脚本 `upper_controller_server.py`：
  - 动作接口：`sendEndAction(EndPayload)`、`sendArmAction(ArmPayload)` 返回 `Response`；
  - 读状态：`recvEndState(Empty) -> EndPayload`、`recvArmState(Empty) -> ArmPayload`；
  - 配置：`setConfig(Config) -> Response`、`getConfig(Empty) -> Config`；
  - 位姿：`setNeckPose(NeckPose)`、`getNeckPose(Empty)`、`setWaistPose(WaistPose)`、`getWaistPose(Empty)`。
- 客户端脚本 `upper_controller_client.py`：对上述接口给出最小用例调用与返回值打印，便于联调与回归测试。

3) Dora 工作流与 UDP 通道
- 以 `openloong-dora-udp/` 为载体，给出以 UDP 为传输层的关节与机械臂控制数据流样例：
  - `servers/` 提供对接 SDK 的参考服务；
  - `workflow/` 提供 Dora 节点与 `dataflow.yml`，演示节点间输入/输出的连线与事件驱动；
  - README 给出运行步骤：启动服务端（8081/8080）→ `dora run workflow/dataflow.yml --uv`。
- 在 `openloong-dora-sim/` 中，`sim_run.sh` 编排仿真窗口、驱动、接口、运动控制，再启动 Dora 工作流，形成“仿真驱动—Dora—应用节点”的完整链路，支持日志输出与清理。

4) LoongPlanner（ROS 局部规划插件）
- 支持路径跟随、自适应局部目标点选择、速度平滑、一阶滤波、终点微调与代价图避障；参数通过 ROS 参数服务器配置，可作为 `move_base` 的 `base_local_planner`。
- 提供参数模板与建议取值区间，有利于与 OpenLoong 控制/感知栈联动。

## 与立项书一致性核对
- 目标与产出方面：
  - 感知/导航与运动控制链路已通过 gRPC 与 UDP 两种通道给出可运行样例；
  - 全身动力学仿真接入工作流链路已有脚本化编排；
  - 强化学习模块未作为本期主要交付内容，但 dora 工作流与 gRPC/UDP 接口设计为后续接入预留扩展点。
- 开发要求方面：
  - 熟悉 dora-rs 架构与 dataflow 配置；
  - 以 Python 为主实现 gRPC server/client 与工作流节点原型；
  - 结合 OpenLoong SDK 完成仿真侧对接和启动编排。

## 开发过程与里程碑
参考 `PROJECT_SUMMARY.md` 开发日志（6/15-7/16）：
- 6/15-6/30：环境搭建与样例熟悉（Dora、OpenLoong 仿真、gRPC 构建尝试）。
- 7/5-7/9：在 macOS/Ubuntu 下从源码构建 gRPC 时遇到 Bazel 测试失败与子模块拉取问题；改用发行版 gRPC，并在此基础上完成导航与上肢控制的 server/client。
- 7/9：`dora run` 解析 `dataflow.yml` 出错（`nodes[1].inputs` 变体不匹配）。
- 7/15：对 dataflow 中节点拆分单测，验证节点功能完整性；配置 Python 远程调试以辅助定位。
- 7/16：仓库清理与分支合并；定位 Dora 输入流 `INPUT_CLOSED` 问题，临时以保持 `trigger` 节点存活规避早退，提出后续基于“就绪信号/心跳”实现优雅退出。

## 遇到的问题与解决方案
1) gRPC 从源码构建不稳定（子模块递归拉取失败、Bazel 测试异常）
- 方案：采用发行版 gRPC，跨 Ubuntu/macOS 验证 server/client，保证可复现构建与运行。

2) Dora dataflow 配置解析失败
- 现象：`nodes[1].inputs` 未匹配到合法变体，运行时报错。
- 方案：拆解为最小工作流，逐节点单测，修正输入端口与类型声明；完善 `dataflow.yml` 的字段与示例注释。

3) Dora 输入流意外关闭（INPUT_CLOSED）
- 现象：节点退出导致上游输入流提前关闭，引发链路中断。
- 临时方案：`trigger` 节点保持运行至最后一个业务节点完成后再退出。
- 永久方案（规划）：引入“就绪/心跳/完成”事件作为工作流内控信号；在 `workflow_orchestrator` 中订阅各节点状态并统一收敛退出条件。

4) 跨平台与依赖一致性
- 方案：脚本化启动（`sim_run.sh`）、README 运行指令、统一端口/路径；合并分支并清理无关追踪，降低环境差异。

## 运行方法与验证
1) gRPC 示例
- 启动导航服务端：
  - `python gps_navigation_grpc/gps_navigation_server.py`（监听 `:50051`）
- 在另一终端运行客户端：
  - `python gps_navigation_grpc/gps_navigation_client.py`（依次调用 `getState → setDestination → startNavi → stopNavi → getState`）
- 启动上肢控制服务端：
  - `python upper_controller/upper_controller_server.py`（监听 `:50052`）
- 客户端验证：
  - `python upper_controller/upper_controller_client.py`（遍历各接口，打印返回值）

2) Dora + UDP 工作流
- 在 `openloong-dora-udp/` 中：
  - 启动服务端：
    - 关节控制（默认 8081）：`python servers/loong_jnt_server.py`
    - 机械臂控制（默认 8080）：`python servers/loong_mani_server.py`
  - 运行工作流：`dora run workflow/dataflow.yml --uv`

3) 全链仿真一键启动
- 在 `openloong-dora-sim/` 中：
  - `bash sim_run.sh`（可加 `--no-jnt` 或 `--no-mani`）
  - 脚本自动拉起仿真/驱动/接口/运动、等待初始化并前台启动 Dora 工作流，日志写入 `openloong-dora-sim/logs/`。

## 评价与对比
- 与 ROS 运行时相比，dora-rs 的数据流编排更轻量，具备流式处理与事件驱动优势；在导航/控制链路打通后，有望在低延迟与吞吐上受益。
- 本仓库以最小可用的 server/client + 工作流样例为主，强调构建/运行可复现；在真实部署中，可替换示例逻辑为算法与控制器实现，并配合 LoongPlanner 进行导航链路收敛。

## 结论与成果
- 产出汇总：
  - gRPC：`gps_navigation_grpc/` 与 `upper_controller/` 完整 server/client 示例，协议来源 `Openloong-proto/`；
  - Dora + UDP：`openloong-dora-udp/` 工作流与节点示例；
  - 仿真编排：`openloong-dora-sim/sim_run.sh` 一键启动形成端到端链路；
  - 文档与协议：`Doc/` PDF、`Openloong-nav-warpper/loong_planner` 参数说明、`PROJECT_SUMMARY.md` 开发日志。
- 目标达成度：完成“Dora 与 OpenLoong”集成样例的端到端链路与可运行验证，明确了后续增强路径。

## 不足与展望
- 不足：
  - 示例逻辑为占位实现，尚未与实际算法/控制器深度耦合；
  - Dora 工作流仍需引入状态管理与心跳，以解决 INPUT_CLOSED 与优雅退出；
  - 强化学习模块未纳入本期交付；
  - 跨平台安装与依赖自动化仍可加强。
- 展望：
  - 引入 CI 做冒烟/接口契约测试与 lint；
  - 将 gRPC/UDP 接口抽象为统一传输层，统一错误码与消息体；
  - 接入实际导航/控制算法，提供标定与仿真-实机一致性评估；
  - 基于 Dora 的 AI 模块编排（VLM/ASR/多模态）与技能管理（`skill_manager.proto`），推动具身智能应用。